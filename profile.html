<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veloskill ¬∑ Profil & Param√®tres</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase.js" defer></script>
  <script src="main.js" defer></script>
</head>

<body data-page="profile">
  <!-- === Banni√®re du profil (remplace le header) === -->
  <section class="profile-banner">
    <div class="banner-content">
      <img class="banner-avatar" data-user-avatar src="https://placehold.co/80x80/ff9100/fff?text=V" alt="Avatar">
      <div>
        <h2 data-user-label>Nom de l'utilisateur</h2>
        <p>Profil cycliste connect√© √† Strava</p>
      </div>
    </div>
  </section>

  <!-- ===== Contenu principal ===== -->
  <main class="profile-page">

    <!-- Profil utilisateur -->
    <section class="profile-form">
      <h2>Mon profil cycliste</h2>
      <form data-profile-form>
        <label>
          Nom
          <input type="text" name="name" required />
        </label>
        <label>
          FTP (Watts)
          <input type="number" name="ftp" min="0" step="1" />
        </label>
        <label>
          Poids (kg)
          <input type="number" name="weight" min="0" step="0.1" />
        </label>
        <label>
          Pays
          <input type="text" name="country" />
        </label>
        <button class="btn primary" type="submit">üíæ Enregistrer</button>
      </form>
    </section>

    <!-- Apparence -->
    <section class="theme-section">
      <h2>Apparence</h2>
      <button class="btn subtle" data-toggle-theme>Changer de th√®me</button>
    </section>

    <!-- Export -->
    <section class="export-section">
      <h2>Export</h2>
      <button class="btn subtle" data-export-json>Exporter mes donn√©es JSON</button>
    </section>

    <!-- Connexion Strava -->
    <section class="strava-section">
      <h2>Connexion Strava</h2>
      <button class="btn primary" data-connect-strava>Connecter Strava üö¥‚Äç‚ôÇÔ∏è</button>
      <p class="small" data-strava-status>Non connect√©</p>
    </section>
    <p class="small" data-sync-status></p>

  </main>

  <!-- ===== Script Strava ===== -->
  <script>
    // --- 1Ô∏è‚É£ Gestion du clic sur "Connecter Strava"
    document.querySelector("[data-connect-strava]").addEventListener("click", () => {
      const clientId = "178503";
      const redirectUri = encodeURIComponent("https://veloskill.vercel.app/profile.html");
      const scope = "read,activity:read_all";

      window.location.href =
        `https://www.strava.com/oauth/authorize?client_id=${clientId}&response_type=code&redirect_uri=${redirectUri}&scope=${scope}`;
    });

    // --- 2Ô∏è‚É£ Gestion du retour Strava (√©change du code contre un token)
    async function handleStravaRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const statusEl = document.querySelector("[data-strava-status]");

      if (!code) return; // pas de code dans l'URL, on ne fait rien

      try {
        // Appel √† l‚ÄôAPI Vercel qui √©change le code contre un token
        const res = await fetch("https://veloskill.vercel.app/api/strava-auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code }),
          cache: "no-store"
        });

        console.log("Status:", res.status);
        const text = await res.text();
        console.log("R√©ponse brute:", text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.warn("R√©ponse non JSON:", text);
        }

        // --- 3Ô∏è‚É£ Connexion r√©ussie
        if (res.ok && data.access_token) {
          statusEl.textContent = `‚úÖ Connect√© √† Strava (${data.athlete.firstname} ${data.athlete.lastname})`;
          console.log("‚úÖ Strava connect√©:", data);

          // --- 4Ô∏è‚É£ Sauvegarde dans Supabase ---
          try {
            const supabaseClient = window.supabase;
            const { data: user } = await supabaseClient.auth.getUser();

            if (user?.user) {
              const { id } = user.user;
              const { error } = await supabaseClient
                .from("profiles")
                .update({
                  strava_id: data.athlete.id.toString(),
                  strava_access_token: data.access_token,
                  strava_refresh_token: data.refresh_token,
                  strava_expires_at: data.expires_at,
                })
                .eq("id", id);

              if (error) console.error("Erreur Supabase:", error);
              else console.log("‚úÖ Tokens Strava enregistr√©s dans Supabase");
            }
          } catch (err) {
            console.error("Erreur lors de la sauvegarde Supabase:", err);
          }

        // --- 5Ô∏è‚É£ Erreur de connexion Strava
        } else {
          statusEl.textContent = `‚ùå Erreur de connexion (HTTP ${res.status})`;
          console.error("‚ùå Erreur:", data);
        }

      } catch (err) {
        console.error("Erreur r√©seau:", err);
        statusEl.textContent = "‚ùå Erreur r√©seau lors de la connexion";
      }
    }

    // --- 3Ô∏è‚É£ V√©rifie si Strava est d√©j√† connect√© (emp√™che reconnexion inutile)
    async function checkStravaStatus() {
      try {
        const supabaseClient = window.supabase;
        const { data: user } = await supabaseClient.auth.getUser();
        if (!user?.user) return;

        const { data: profile } = await supabaseClient
          .from("profiles")
          .select("strava_access_token, strava_expires_at, strava_id")
          .eq("id", user.user.id)
          .single();

        const statusEl = document.querySelector("[data-strava-status]");
        const btn = document.querySelector("[data-connect-strava]");

        if (profile?.strava_access_token) {
          statusEl.textContent = "‚úÖ Connect√© √† Strava";
          btn.textContent = "Reconnecter Strava";
          btn.classList.add("connected");
        } else {
          statusEl.textContent = "Non connect√©";
          btn.textContent = "Connecter Strava üö¥‚Äç‚ôÇÔ∏è";
          btn.classList.remove("connected");
        }
      } catch (err) {
        console.error("Erreur lors de la v√©rification du statut Strava:", err);
      }
    }

    // --- 4Ô∏è‚É£ Rafra√Æchit automatiquement le token Strava s‚Äôil est expir√©
    async function refreshStravaTokenIfNeeded() {
        const supabaseClient = window.supabase;
        const { data: user } = await supabaseClient.auth.getUser();
        if (!user?.user) return;

        const { data: profile, error } = await supabaseClient
            .from("profiles")
            .select("strava_access_token, strava_refresh_token, strava_expires_at")
            .eq("id", user.user.id)
            .single();

        if (error || !profile) return;

        const now = Math.floor(Date.now() / 1000);
        if (profile.strava_expires_at > now) {
            console.log("‚úÖ Token Strava encore valide");
            return; // encore bon
        }

        console.log("üîÅ Token Strava expir√©, rafra√Æchissement en cours...");

        try {
            const res = await fetch("https://veloskill.vercel.app/api/strava-refresh", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh_token: profile.strava_refresh_token }),
            });

            const data = await res.json();
            if (!res.ok || !data.access_token) throw new Error(JSON.stringify(data));

            // Mise √† jour du token dans Supabase
            const { error: updateError } = await supabaseClient
            .from("profiles")
            .update({
                strava_access_token: data.access_token,
                strava_refresh_token: data.refresh_token,
                strava_expires_at: data.expires_at,
            })
            .eq("id", user.user.id);

            if (updateError) console.error("Erreur mise √† jour token:", updateError);
            else console.log("‚úÖ Token Strava rafra√Æchi automatiquement");
        } catch (err) {
            console.error("Erreur refresh Strava:", err);
        }
    }

    // --- 5Ô∏è‚É£ Synchronise automatiquement les activit√©s Strava r√©centes
    async function syncRecentActivities() {
        const supabaseClient = window.supabase;
        const { data: user } = await supabaseClient.auth.getUser();
        if (!user?.user) return;

        const { data: profile, error } = await supabaseClient
            .from("profiles")
            .select("strava_access_token")
            .eq("id", user.user.id)
            .single();

        const syncEl = document.querySelector("[data-sync-status]"); // <-- on s√©lectionne ton <p>
        if (syncEl) syncEl.textContent = "‚è≥ Synchronisation en cours...";

        if (error || !profile?.strava_access_token) {
            console.warn("Aucun token Strava disponible pour la synchro");
            if (syncEl) syncEl.textContent = "‚ùå Aucune connexion Strava trouv√©e";
            return;
        }

        console.log("üîÅ Synchronisation des derni√®res activit√©s Strava...");

        try {
            const res = await fetch("https://veloskill.vercel.app/api/strava-sync", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user_id: user.user.id,
                access_token: profile.strava_access_token,
            }),
            });

            const data = await res.json();

            if (res.ok) {
            console.log(`‚úÖ ${data.imported} nouvelles activit√©s import√©es`);
            if (syncEl)
                syncEl.textContent = `‚úÖ ${data.imported} nouvelles activit√©s synchronis√©es`;
            } else {
            console.error("‚ùå Erreur synchro Strava:", data);
            if (syncEl) syncEl.textContent = "‚ùå Erreur pendant la synchronisation";
            }
        } catch (err) {
            console.error("Erreur r√©seau pendant la synchro Strava:", err);
            if (syncEl) syncEl.textContent = "‚ùå Erreur r√©seau pendant la synchronisation";
        }
    }

    // --- Initialisation au chargement
    handleStravaRedirect();
    checkStravaStatus();
    refreshStravaTokenIfNeeded().then(syncRecentActivities);
  </script>
</body>
</html>
